# Setup & Pre-reqs
# export KUBECONFIG=[FULL_PATH_TO_KUBECONFIG_FILE]
# Install Helm on client
# brew install helm
# export KUBE_DEPLOY_BASE_PATH=[FULL_PATH_TO_DEPLOY_FOLDER]
# export KUBE_NAMESPACE=[YOUR_NAMESPACE]

# Helm setup

# Add the Jetstack Helm repository
helm repo add jetstack https://charts.jetstack.io

# Update your local Helm chart repository cache
helm repo update


# Deployment

# Create Namespace
kubectl apply -f $KUBE_DEPLOY_BASE_PATH/namespace

## Uninstall a previous cert-manager if installed
# helm uninstall cert-manager --namespace [old-namespace]

# Install cert manager helm chart
helm install \
  cert-  jetstack/cert-manager \
  --namespace $KUBE_NAMESPACE \
  --version v0.15.1 \
  -f $KUBE_DEPLOY_BASE_PATH/cert-manager/values.yaml \
  --set installCRDs=true
  

# Let's encrypt issuer staging
kubectl apply -f $KUBE_DEPLOY_BASE_PATH/cluster-issuer/staging

# Application
kubectl apply -f $KUBE_DEPLOY_BASE_PATH/deployment

# Ingress
kubectl apply -f $KUBE_DEPLOY_BASE_PATH/ingress

# Loadbalancer
kubectl apply -f $KUBE_DEPLOY_BASE_PATH/load-balancer

# Certificate
kubectl apply -f $KUBE_DEPLOY_BASE_PATH/certificate

# Validation
kubectl --namespace $KUBE_NAMESPACE get services
kubectl --namespace $KUBE_NAMESPACE get pods
# kubectl --namespace $KUBE_NAMESPACE logs [POD_NAME]
kubectl --namespace $KUBE_NAMESPACE describe ingress

